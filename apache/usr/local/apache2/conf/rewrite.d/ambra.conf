#
# NOT Managed by salt - watch your changes disappear!
#
# Shared rules for all Ambra sites

Header edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure

RewriteEngine on

# First we set environment vars + cookies
# Begin with device detection + user intent:
RewriteRule .? - [E=site_hit:ambra]
Include conf/rewrite.d/detectify.conf

# Use mod_expires to set cache-control headers
<IfModule mod_expires.c>
        # Enable expirations.
        ExpiresActive On
        # Cache all files for 1 day after access (A).
        ExpiresDefault A86400
        # Do not cache dynamically generated pages.
        ExpiresByType text/html A1
</IfModule>

# Inappropriate
RewriteRule ^/manager/ /? [R,L]

# And now a big morass of rewrites...

# Static files
RewriteRule ^/google(.*)        /google/journalNamePlaceholder$1
RewriteRule ^/xml(.*)           /google/journalNamePlaceholder$1
RewriteRule ^/suppinfo(.*)      /journals/journalNamePlaceholder/webapp/suppinfo$1

# Enhanced articles
<Location /enhanced>
  DirectoryIndex index.html index.htm
</Location>

# User profiles
RewriteRule .*alerts(/journal)?$        https://community.plos.org/account/alerts/journal-alerts? [R=301,L]
RewriteRule .*alerts/search$            https://community.plos.org/account/alerts/search-alerts? [R=301,L]
RewriteRule .*user/[^/]+$               https://community.plos.org? [R=301,L]

# Shorties
RewriteRule ^/doi/(.*)      /article/info:doi/10.1371/journal.$1 [R=301,L,NE]

# Fix incorrectly formed legacy static urls (which somehow have been indexed by Google)
RewriteRule ^/static/static/(.*) /static/$1

# Forbidden
RedirectMatch 503 articleList.action
RewriteRule .ftl$	- [F]

# new site content pages
RewriteRule ^/downloads/rcuk\.pdf http://www.plos.org/publications/publish-plos/rcuk-open-access-policy [R=301]
RewriteRule ^/static/about /s/journal-information [R=301]
RewriteRule ^/static/advisory_board http://www.plosone.org/static/edboard [L,R=301]
RewriteRule ^/static/advisory_group /s/advisory-groups#loc-animal-research-advisory-group [R=301,NE]
RewriteRule ^/static/aeGuidelines /s/editorial-and-peer-review-process [R=301]
RewriteRule ^/static/almInfo http://lagotto.io/plos/ [L,R=301]
RewriteRule ^/static/checklist /s/submit-now [R=301]
RewriteRule ^/static/commentGuidelines /s/comments [R=301]
RewriteRule ^/static/competing /s/competing-interests [R=301]
RewriteRule ^/static/contact /s/contact [R=301]
RewriteRule ^/static/corrections /s/corrections-and-retractions [R=301]
RewriteRule ^/static/descriptions /s/other-article-types [R=301]
RewriteRule ^/static/developing /s/journal-information#loc-developing-countries [R=301,NE]
RewriteRule ^/static/dryad /s/data-availability [R=301]
RewriteRule ^/static/edSerGuides /s/other-article-types#loc-education-series [R=301,NE]
RewriteRule ^/static/faq /s/journal-information [R=301]
RewriteRule ^/static/ghostwriting /s/figures#loc-file-requirements [R=301,NE]
RewriteRule ^/static/help /s/help-using-this-site [R=301]
RewriteRule ^/static/home / [R=301]
RewriteRule ^/static/human_research_advisory_group /s/advisory-groups#loc-human-research-advisory-group [R=301,NE]
RewriteRule ^/static/imageManipulation /s/figures#loc-image-manipulation [R=301,NE]
RewriteRule ^/static/information /s/journal-information [R=301]
RewriteRule ^/static/latexGuidelines /s/latex [R=301]
RewriteRule ^/static/license /s/licenses-and-copyright [R=301]
RewriteRule ^/static/plos_consent_form_french\.pdf /s/file?id=GVge/plos-consent-form-french.pdf [R=301,NE]
RewriteRule ^/static/plos_consent_form_portuguese\.pdf /s/file?id=LGJC/plos-consent-form-portuguese.pdf [R=301,NE]
RewriteRule ^/static/plos_consent_form_spanish\.pdf /s/file?id=eQJp/plos-consent-form-spanish.pdf [R=301,NE]
RewriteRule ^/static/plos_consent_form\.pdf /s/file?id=5/bA/plos-consent-form-english.pdf [R=301,NE]
RewriteRule ^/static/plos_template\.zip /s/file?id=SyJ3/plos-latex-template.zip [R=301,NE]
RewriteRule ^/static/privacy http://www.plos.org/about/privacy-policy [L,R=301]
RewriteRule ^/static/rcuk http://www.plos.org/publications/publish-plos/rcuk-open-access-policy [L,R=301]
RewriteRule ^/static/resources /s/resources [R=301]
RewriteRule ^/static/reviewerForm /s/reviewer-guidelines#loc-writing-the-review [R=301,NE]
RewriteRule ^/static/revisedChecklist /s/revising-your-manuscript [R=301]
RewriteRule ^/static/robotsFilter /s/list-of-filtered-robots-spiders [R=301]
RewriteRule ^/static/rssFeeds /s/help-using-this-site#loc-article-feeds [R=301,NE]
RewriteRule ^/static/rssInfo /s/help-using-this-site#loc-article-feeds [R=301,NE]
RewriteRule ^/static/scope /s/journal-information#loc-scope [R=301,NE]
RewriteRule ^/static/searchHelp /s/search-tips [R=301]
RewriteRule ^/static/section_editors /s/section-editors [R=301]
RewriteRule ^/static/statistical_advisors /s/advisory-groups#loc-statistical-advisors [R=301,NE]
RewriteRule ^/static/submissionInstructions /s/submit-now [R=301]
RewriteRule ^/static/supportingInformation /s/supporting-information [R=301]
RewriteRule ^/static/terms http://www.plos.org/about/terms-use [L,R=301]
RewriteRule ^/static/usageData /s/usage-data-help [R=301]
RewriteCond %{HTTP_HOST} ^www\.plos(clinicaltrials|biology|collections|compbiol|genetics|medicine|ntds|one|pathogens)\.org$
RewriteCond %{HTTP_HOST} !one
RewriteRule ^/static/edboard /s/editorial-board [R=301]
RewriteCond %{HTTP_HOST} ^www\.plosone\.org$
RewriteRule ^/static/edboard http://${JOURNALS_HOST}/plosone/static/editorial-board [L,R=301]

# site content redirects from urls with anchors are handled client-side via wombat RedirectController/redirect.ftl
RewriteRule ^/static/eic /redirect/eic?defaultTarget=s/editors-in-chief [R,NE]
RewriteRule ^/static/figureGuidelines /redirect/figureGuidelines?defaultTarget=s/figures [R,NE]
RewriteRule ^/static/figureInstructions /redirect/figureInstructions?defaultTarget=s/figures [R,NE]
RewriteRule ^/static/figuresfaq /redirect/figuresfaq?defaultTarget=s/figures [R,NE]
RewriteRule ^/static/figureSpecifications /redirect/figureSpecifications?defaultTarget=s/figures [R,NE]
RewriteRule ^/static/guidelines /redirect/guidelines?defaultTarget=s/submission-guidelines [R,NE]
RewriteRule ^/static/policies /redirect/policies?defaultTarget=s/editorial-and-publishing-policies [R,NE]
RewriteRule ^/static/publication /redirect/publication?defaultTarget=s/criteria-for-publication [R,NE]
RewriteRule ^/static/reviewerGuidelines /redirect/reviewerGuidelines?defaultTarget=s/reviewer-guidelines [R,NE]
RewriteRule ^/static/tableSpecifications /redirect/tableSpecifications?defaultTarget=s/tables [R,NE]
RewriteRule ^/static/editorial$ /redirect/editorial?defaultTarget=s/editorial-and-publishing-policies [R,NE]
RewriteRule ^/static/editorsInterests /redirect/editorsInterests?defaultTarget=s/competing-interests-of-the-plos-medicine-editors [R,NE]


# Fix incorrect article accesses
# (e.g. accessing a pntd article via plosone.org)
# Ambra allows this, but we don't want it
#
# We must repeat the following stanza for each journal
# because our version of Apache doesn't support <if/else>
#  - First, make sure we're already accessing via a canonical URL...
#  - Second, we special-case collections and clinicaltrials
#  - Third, check for the mismach
#  - Finally, rewrite...

# Fix pbio
RewriteCond %{HTTP_HOST} ^www\.plos(clinicaltrials|biology|collections|compbiol|genetics|medicine|ntds|one|pathogens)\.org$
RewriteCond %{HTTP_HOST} !biology
RewriteCond %{REQUEST_URI} (journal|issue|image)\.pbio [OR]
RewriteCond %{QUERY_STRING} (journal|issue|image)\.pbio
RewriteRule ^/(.*) http://www.plosbiology.org/$1 [L,R,NE]

# Fix pcbi
RewriteCond %{HTTP_HOST} ^www\.plos(clinicaltrials|biology|collections|compbiol|genetics|medicine|ntds|one|pathogens)\.org$
RewriteCond %{HTTP_HOST} !compbiol
RewriteCond %{REQUEST_URI} (journal|issue|image)\.pcbi [OR]
RewriteCond %{QUERY_STRING} (journal|issue|image)\.pcbi
RewriteRule ^/(.*) http://www.ploscompbiol.org/$1 [L,R,NE]

# Fix pgen
RewriteCond %{HTTP_HOST} ^www\.plos(clinicaltrials|biology|collections|compbiol|genetics|medicine|ntds|one|pathogens)\.org$
RewriteCond %{HTTP_HOST} !genetics
RewriteCond %{REQUEST_URI} (journal|issue|image)\.pgen [OR]
RewriteCond %{QUERY_STRING} (journal|issue|image)\.pgen
RewriteRule ^/(.*) http://www.plosgenetics.org/$1 [L,R,NE]

# Fix pmed
RewriteCond %{HTTP_HOST} ^www\.plos(clinicaltrials|biology|collections|compbiol|genetics|medicine|ntds|one|pathogens)\.org$
RewriteCond %{HTTP_HOST} !medicine
RewriteCond %{REQUEST_URI} (journal|issue|image)\.pmed [OR]
RewriteCond %{QUERY_STRING} (journal|issue|image)\.pmed
RewriteRule ^/(.*) http://www.plosmedicine.org/$1 [L,R,NE]

# Fix pntd
RewriteCond %{HTTP_HOST} ^www\.plos(clinicaltrials|biology|collections|compbiol|genetics|medicine|ntds|one|pathogens)\.org$
RewriteCond %{HTTP_HOST} !ntds
RewriteCond %{REQUEST_URI} (journal|issue|image)\.pntd [OR]
RewriteCond %{QUERY_STRING} (journal|issue|image)\.pntd
RewriteRule ^/(.*) http://www.plosntds.org/$1 [L,R,NE]

# Fix ppat
RewriteCond %{HTTP_HOST} ^www\.plos(clinicaltrials|biology|collections|compbiol|genetics|medicine|ntds|one|pathogens)\.org$
RewriteCond %{HTTP_HOST} !pathogens
RewriteCond %{REQUEST_URI} (journal|issue|image)\.ppat [OR]
RewriteCond %{QUERY_STRING} (journal|issue|image)\.ppat
RewriteRule ^/(.*) http://www.plospathogens.org/$1 [L,R,NE]

# Fix pone
RewriteCond %{HTTP_HOST} ^www\.plos(clinicaltrials|biology|collections|compbiol|genetics|medicine|ntds|one|pathogens)\.org$
RewriteCond %{HTTP_HOST} !one
RewriteCond %{REQUEST_URI} (journal|issue|image)\.pone [OR]
RewriteCond %{QUERY_STRING} (journal|issue|image)\.pone
RewriteRule ^/(.*) http://www.plosone.org/$1 [L,R,NE]


# Fix double-escaped DOI scheme in query string (see DPRO-2679)
RewriteCond %{QUERY_STRING} ^(.*)info%253Adoi%252F10.1371%252F(.*)$
RewriteRule (.*) $1?%1info:doi/10.1371/%2 [L,R,NE]

# Now include the Wombatifier.
Include conf/rewrite.d/wombatify.conf
# Rewrites in this file will take effect if we already
# know that the user is destined for the mobile site.
#
# Included at the bottom, because we want to have
# plowed through more or less the full
# set of Ambra fixups first.
