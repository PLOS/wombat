#
# Managed by salt - watch your changes disappear!
#
# WOMBATIFY
#
# Send users to Wombat
# (if they belong there)
#
# Two RewriteMaps make this possible
# First, a hash (generated via DB query)
# to map annotation IDs -> URIs
RewriteMap annotationIDtoURI txt:/usr/local/apache2/conf/data/annotationIDtoURI.txt
# Second, the internal unescape facility
# so we can match cleanly on dois/etc.
RewriteMap unescape int:unescape

# Snag the hostname, to use as the Wombat site key:
RewriteCond %{HTTP_HOST} ^(?:www\.)?(.+)\.org
RewriteRule .? - [E=site:%1]
# Now, unescape both URI + query string, and begin rewriting:
RewriteCond %{QUERY_STRING} ^(.*)$
RewriteRule ^/(.*)$ /${unescape:$1}?${unescape:%1} [NE]

# Ambra->Wombat URL mapping happens in this block.
#
# Some pages will get unconditionally rewritten to Wombat
# Others will only get rewritten if the user is+wants mobile
#
# We set an env var with each of these matches to flag
# that a rewrite should actually occur.  Otherwise, arbitrary
# pages that don't have a Wombat equivalent will get caught
# by the final rewrite, which we don't want.
#

# Clinical Trials - homepage is a hard redirect to a collection
RewriteCond %{ENV:site} plosclinicaltrials
RewriteRule ^/($|home(\.action)?) http://${COLLECTIONS_HOST}/plos-clinical-trials [NC,L,R=permanent]

# Homepage (Remaining journals) - everyone gets Wombat
RewriteRule ^/($|home(\.action)?) /? [NC,E=rewrite_to_wombat:true]

# old fetch actions
RewriteCond %{QUERY_STRING} uri=info:doi/(.+)&representation=(.+)
RewriteRule ^/article/fetchObject /article/asset?id=%1.%2 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} representation=(.+)&uri=info:doi/(.+)
RewriteRule ^/article/fetchObject /article/asset?id=%2.%1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} uri=(.+)
RewriteRule ^/article/fetchSingleRepresentation /article/asset?unique&id=%1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} uri=info:doi/(.+)
RewriteRule ^/article/fetchPowerPoint /article/figure/powerpoint?id=%1 [NC,NE,E=rewrite_to_wombat:true]
RewriteRule ^/article/info:doi/(.+)/powerpoint /article/figure/powerpoint?id=$1 [NC,NE,E=rewrite_to_wombat:true]
RewriteRule ^/article/info:doi/(.+)/originalimage /article/figure/image?size=original&id=$1 [NC,NE,E=rewrite_to_wombat:true]
RewriteRule ^/article/info:doi/(.+)/largerimage /article/figure/image?size=large&id=$1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} articleURI=info:doi/(.+)
RewriteRule ^/article/fetchArticle(.action)?$ /article?id=%1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} uri=info:doi/(.+)
RewriteRule ^/article/fetchFullDOIXML /article/asset?id=%1.XML [NC,NE,E=rewrite_to_wombat:true]
# Article
RewriteRule ^/article/info:doi/(.+) /article?id=$1 [NC,NE,E=rewrite_to_wombat:true]
# Article (About the Authors)
RewriteRule ^/article/authors/info:doi/(.+) /article/authors?id=$1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} articleURI=info:doi/(.+)
RewriteRule ^/article/fetchArticleAuthors(.action)?$ /article/authors?id=%1 [NC,NE,E=rewrite_to_wombat:true]
# Article (Comments)
RewriteRule ^/article/comments/info:doi/(.+) /article/comments?id=$1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} articleURI=info:doi/(.+)
RewriteRule ^/article/fetchArticleComments(.action)?$ /article/comments?id=%1 [NC,NE,E=rewrite_to_wombat:true]
# Individual Comment
RewriteCond %{QUERY_STRING} root=(\d+)
RewriteRule ^/annotation/listThread /article/comment?id=${annotationIDtoURI:%1} [NC,NE,E=rewrite_to_wombat:true]
#Article Related Content
RewriteRule ^/article/related/info:doi/(.+) /article/related?id=$1 [NC,NE,E=rewrite_to_wombat:true]
# Article citation list
RewriteCond %{QUERY_STRING} articleURI=info:doi/(.+)
RewriteRule ^/article/citationList /article/citation?id=%1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} articleURI=info:doi/(.+)
RewriteRule ^/article/getBibTexCitation /article/citation/bibtex?id=%1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} articleURI=info:doi/(.+)
RewriteRule ^/article/getRisCitation /article/citation/ris?id=%1 [NC,NE,E=rewrite_to_wombat:true]
# Email this article
RewriteRule ^/article/email/info:doi/(.+) /article/email?id=$1 [NC,NE,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} articleURI=info:doi/(.+)
RewriteRule ^/article/emailArticle /article/email?id=%1 [NC,NE,E=rewrite_to_wombat:true]
# Twitter list
RewriteRule ^/article/twitter/info:doi/(.+) http://alm.plos.org/works/doi.org/$1?source_id=twitter [NC,L,R=permanent]
# Crossref list
RewriteRule ^/article/crossref/info:doi/(.+) http://alm.plos.org/works/doi.org/$1?source_id=crossref [NC,L,R=permanent]
# Simple Search Results
RewriteCond %{ENV:serve} =mobile
RewriteRule ^/search/simple /search [NC,E=rewrite_to_wombat:true]

# Browse Issue (all but old ploscollections issues -> new collections pages, which are handled in ploscollections.conf)
RewriteCond %{ENV:site} !(ploscollections)
RewriteRule ^/article/browse.*(10\.1371.*issue\..{4}\.v\d+\.i\d+) /issue?id=$1 [NC,NE,E=rewrite_to_wombat:true]

RewriteCond %{ENV:site} !(ploscollections)
RewriteCond %{QUERY_STRING} (10\.1371.*issue\..{4}\.v\d+\.i\d+)
RewriteRule ^/article/browse.* /issue?id=%1 [NC,NE,E=rewrite_to_wombat:true]

# Browse Current Issue (captures /article/browse/issue & article/browseIssue.action)
RewriteCond %{ENV:site} !(ploscollections)
RewriteRule ^/article/browse.{1,2}ssue.* /issue? [NC,E=rewrite_to_wombat:true]

# Browse Volume (captures /article/browse/volume & article/browseVolume.action)
RewriteCond %{ENV:site} !(ploscollections)
RewriteRule ^/article/browse.{1,2}olume.* /volume [NC,E=rewrite_to_wombat:true]

# subject are landing page for plos one
RewriteCond %{ENV:site} =plosone
RewriteRule ^/browse - [NC,E=rewrite_to_wombat:true]
RewriteCond %{ENV:site} =plosone
RewriteRule ^/taxonomy$ /browse [NC,E=rewrite_to_wombat:true]
RewriteCond %{ENV:site} =plosone
RewriteRule ^/taxonomy/browse/([^;]+)$ /browse/$1 [NC,E=rewrite_to_wombat:true]
RewriteCond %{ENV:site} =plosone
RewriteCond %{QUERY_STRING} ^$
RewriteRule ^/article/browse/([^;]+)$ /browse/$1 [NC,E=rewrite_to_wombat:true]
# rewrite super-old browse URL to merely old URL
RewriteCond %{ENV:site} =plosone
RewriteCond %{QUERY_STRING} selectedSubjects=([^&]+)
RewriteRule ^/article/browse(.action)?$ /article/browse.action?catName=%1 [NC,NE]
# replace + with _ iteratively for old browse URLs
RewriteCond %{ENV:site} =plosone
RewriteCond %{QUERY_STRING} catName=([^&]+)\+([^&]+)
RewriteRule ^/article/browse(.action)?$ /article/browse.action?catName=%1_%2 [NC,NE,R,L]
RewriteCond %{ENV:site} =plosone
RewriteCond %{QUERY_STRING} catName=([^&]+)
RewriteRule ^/article/browse(.action)?$ /browse/%1? [NC,E=rewrite_to_wombat:true]

# Advanced search results
RewriteCond %{QUERY_STRING} unformattedQuery=.+
RewriteCond %{QUERY_STRING} !noSearchFlag
RewriteRule ^/search/advanced?(.+) /search [NC,E=rewrite_to_wombat:true,QSA]
# Advanced search form now also hosted by Wombat (empty form so params ignored)
RewriteCond %{QUERY_STRING} noSearchFlag
RewriteRule ^/search/advanced?(.+) /search? [NC,E=rewrite_to_wombat:true]

# Ambra "quick search": used for searching by volume number, eLocationId,
# or DOI.
RewriteRule ^/search/quick?(.+) /search [NC,E=rewrite_to_wombat:true,QSA]

# Rewrite any simple search queries from pages served by ambra to the
# corresponding wombat page.
RewriteCond %{QUERY_STRING} (.*)query=(.+)
RewriteRule ^/search/simple.* /search?%1q=%2 [NC,E=rewrite_to_wombat:true]

# new site content pages
RewriteRule ^/siteContent/(.+) /s/$1 [NC,E=rewrite_to_wombat:true] # updated links from old ambra site menu
RewriteRule ^/redirect/.* - [NC,E=rewrite_to_wombat:true] # urls with anchors are redirected client-side via RedirectController
RewriteRule ^/s/.* - [NC,E=rewrite_to_wombat:true]

# new metrics tab
RewriteRule ^/article/metrics/info:doi/(.+) /article/metrics?id=$1 [NC,E=rewrite_to_wombat:true]
RewriteCond %{QUERY_STRING} articleURI=info:doi/(.+)
RewriteRule ^/article/fetchArticleMetrics(.action)?$ /article/metrics?id=%1 [NC,NE,E=rewrite_to_wombat:true]

# "Why Publish with PLOS ONE" page
# (old static page that is a true static page, not site content, in Wombat)
RewriteCond %{ENV:site} =plosone
RewriteRule ^/static/publish/? /static/publish [NC,E=rewrite_to_wombat:true]

# RSS feed for new articles
RewriteCond %{QUERY_STRING} ^$
RewriteRule ^/article/feed/?$ /feed/atom [NC,E=rewrite_to_wombat:true]

# RSS feed for comments
RewriteCond %{QUERY_STRING} ^type=Annotation
RewriteRule ^/article/feed/?$ /feed/comments/atom? [NC,E=rewrite_to_wombat:true]

# RSS feed for subject area landing page
RewriteCond %{ENV:site} =plosone
RewriteCond %{QUERY_STRING} ^categories=(.*)
RewriteRule ^/article/feed/?$ /search/feed/atom?filterJournals=PLoSONE&sortOrder=DATE_NEWEST_FIRST&q=subject:%1 [NC,NE,E=rewrite_to_wombat:true]

# RSS feed for search results
RewriteRule ^/article/feed/search/?$ /search/feed/atom?sortOrder=DATE_NEWEST_FIRST [NC,NE,QSA,E=rewrite_to_wombat:true]

Header add X-Wombatify-Debug "site:%{site}e serve:%{serve}e rewrite_to_wombat:%{rewrite_to_wombat}e"

# assign default URL prefix for wombat if not already set
RewriteCond %{ENV:wombat_url_prefix} ^$
RewriteRule .* - [E=wombat_url_prefix:${JOURNALS_HOST}/%{ENV:site}]

# Finally, send them on their way...
RewriteCond %{ENV:rewrite_to_wombat} =true
RewriteRule ^/(.*)$ http://%{ENV:wombat_url_prefix}/$1 [R=301,L,NE]
