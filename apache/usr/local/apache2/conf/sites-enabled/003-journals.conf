<VirtualHost *:80>
  ServerAdmin admin@plos.org
  DocumentRoot /var/www/wombat
  ServerName ${JOURNALS_HOST}
  AllowEncodedSlashes On

  # Inject cache headers
  <IfModule mod_expires.c>
    # Enable expirations.
    ExpiresActive On
    # Cache all files for 1 day after access (A).
    ExpiresDefault A86400
    # Do not cache dynamically generated pages.
    ExpiresByType text/html A1
  </IfModule>

  RewriteEngine on

  # canonical url redirect
  #RewriteCond %{HTTP_HOST}   !^%{SERVER_NAME}$ [NC]
  #RewriteRule ^/(.*)         http://${JOURNALS_HOST}/$1 [L,R=permanent,NE]

  # A long time ago, journals.plos.org hosted our journals
  # At some point we 301ed those to Ambra and other places
  # Some of the old rewrites we must still keep in place...

  # send logged out users to the referring page (the site homepage)
  RewriteRule ^/user/logout %{HTTP_REFERER} [L,R,NE]

  # moved site content pages
  RewriteRule ^/plosntds/s/resources /plosntds/s/commitment-to-capacity [L,R=permanent]
  RewriteRule ^(.*)/s/content-license$ $1/s/licenses-and-copyright [L,R=permanent]

  # And robots.txt is served straight offa disk
  RewriteRule ^/robots.txt$ /robots.txt [L]

  # Sitemaps served from nfs mounted soft link: ITI-1469
  RewriteRule ^/sitemaps - [L]

  # Client-side redirects are logged like standard apache redirects for tracking purposes.
  # The client-side redirect Javascript will make an Ajax request to this URL.
  RewriteRule /logRedirect/ - [L,F]

  # Now for UA detection/site decision
  RewriteRule .? - [E=site_hit:wombat]
  Include conf/rewrite.d/detectify.conf

  # redirect collections homepage to new domain
  RewriteRule ^/ploscollections/?$ http://${COLLECTIONS_HOST} [NC,L,R=permanent]

  # redirect article urls containing the collections site path token to their journal of origin
  # since articles within collections no longer use collections site branding
  RewriteCond %{QUERY_STRING} journal.pbio\.[^\.]+
  RewriteRule ^/ploscollections/article$ /plosbiology/article [NC,L,R=permanent]

  RewriteCond %{QUERY_STRING} journal.pcbi\.[^\.]+
  RewriteRule ^/ploscollections/article$ /ploscompbiol/article [NC,L,R=permanent]

  RewriteCond %{QUERY_STRING} journal.pgen\.[^\.]+
  RewriteRule ^/ploscollections/article$ /plosgenetics/article [NC,L,R=permanent]

  RewriteCond %{QUERY_STRING} journal.pmed\.[^\.]+
  RewriteRule ^/ploscollections/article$ /plosmedicine/article [NC,L,R=permanent]

  RewriteCond %{QUERY_STRING} journal.pntd\.[^\.]+
  RewriteRule ^/ploscollections/article$ /plosntds/article [NC,L,R=permanent]

  RewriteCond %{QUERY_STRING} journal.ppat\.[^\.]+
  RewriteRule ^/ploscollections/article$ /plospathogens/article [NC,L,R=permanent]

  RewriteCond %{QUERY_STRING} journal.pone\.[^\.]+
  RewriteRule ^/ploscollections/article$ /plosone/article [NC,L,R=permanent]

  # Redirect Clinical Trials homepage to the collection that replaces it
  RewriteRule ^/plosclinicaltrials/?$ http://${COLLECTIONS_HOST}/plos-clinical-trials [NC,L,R=permanent]

  # All journals now share the same publications fees page
  RewriteRule ^(.*)/s/publication-fees$ https://www.plos.org/publication-fees [L,R=permanent]

  # plosbiology redirects
  # Can't be done in 004-biology.conf because 0003-journals.conf ends with a rewrite rule to pass through to Wombat that captures everything.
  RewriteRule ^(.*)/plosbiology/s/other-article-types$ $1/plosbiology/s/what-we-publish [L,R=permanent]

# Everything not already rewritten goes to Wombat
  RequestHeader add "X-Zoowodily-Rocks" "True"
  RequestHeader add "X-Wombat-Serve" "%{serve}e"
  RewriteRule ^/(.*) http://localhost/:8080/$1 [P]
  ProxyPassReverse / http://localhost/:8080/

  # All hail the new journals.plos.org

  SetEnvIf User-Agent "KEMP.*" nolog
  SetEnvIf User-Agent "check_http.*" nolog
  CustomLog "|/usr/bin/logger -p local6.info -t journals" lb_vhost_combined env=!nolog
  CustomLog "|/usr/bin/cronolog /var/log/apache2/combined-%Y%m%d-access_log" lb_combined env=!nolog
</VirtualHost>
