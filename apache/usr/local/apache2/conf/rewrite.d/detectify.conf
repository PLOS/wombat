#
# DETECTIFY
#
# Figure out what our users are accessing us with
# and do our best to respect their decision...
#
# The magic ingredient in device detection
# is the database at user-agent-string.info
#
# We shell out (via RewriteMap) to a PHP script
# that answers a simple question:
# * is the user mobile or not?
#
# Why PHP?
#
# Well, because the PHP library they provide for
# parsing their giant user agent database is the
# most full-featured.  That's why.
#RewriteMap device_detect prg:/usr/lib64/httpd/device-detect.php
RewriteRule .? - [E=device_type:desktop,co=plos-device-detected:desktop:.%{HTTP_HOST}:120]
# This Included file is generated by a python script.
Include conf/rewrite.d/detect-mobile-regex.txt
# We save the UA match in a cookie to avoid having
# to hit the PHP too much.  Needing to match the UA
# string against thousands of regexes on every
# request is a bit excessive.

# ___________________________
#
# PHASE ONE: DEVICE DETECTION
# ___________________________
#


# ___________________________
#
#    PHASE TWO: USER LOVE
# ___________________________
#

# OK, so we know what we're working with. But what about
# our user's wishes?
# There's a query string for that!
#
# SCENARIO #1: User provides query string
#
RewriteCond %{QUERY_STRING} ^(.*)&?fullSite$
# We want to remove fullSite from the query string,
# then set the env var + cookie
RewriteRule ^(.*)$ $1?%1 [E=wanted:desktop,co=full-site-desired:true:.%{HTTP_HOST}]
#
# SCENARIO #2: User is already cookied
#
RewriteCond %{HTTP_COOKIE} full-site-desired=true
RewriteCond %{QUERY_STRING} ^(.*)$
# And then set our env var...
RewriteRule ^(.*)$ $1?%1 [E=wanted:desktop]

# ___________________________
#
#   PHASE THREE: DECISIONS
# ___________________________
#

#
# Now we need to set a flag which will be used in later
# decisions about whether to actually rewrite the user's request
#
# SCENARIO #1: Desktop user hits Ambra
# (post-redirect from Wombat)
#
# Special scenario since Wombat can't issue
# a cross-domain cookie.  This will cookie us
# for the particular journal site (plosone.org,etc.)
#
# The extra redirect is unavoidable. We do this first
# to cut off any further processing.
#
RewriteRule ^/fullSite/(.*)$ http://%{HTTP_HOST}/$1 [co=full-site-desired:true:.%{HTTP_HOST},R,L]
#
# SCENARIO #2: Mobile user, wants mobile
#
RewriteCond %{ENV:device_type} =mobile
RewriteCond %{ENV:wanted} !=desktop
RewriteRule .? - [E=serve:mobile]
#
# SCENARIO #3: Mobile user, wants desktop
#
RewriteCond %{ENV:device_type} =mobile
RewriteCond %{ENV:wanted} =desktop
RewriteRule .? - [E=serve:desktop]
#
# SCENARIO #3: Desktop user
#
RewriteCond %{ENV:device_type} =desktop
RewriteRule .? - [E=serve:desktop]

# To debug, uncomment the following:
# Header add X-Detectify-Debug "dev: %{device_type}e, site: %{site_hit}e, want:%{wanted}e, serve:%{serve}e"
